@using CelHost.Fronter.Apis
@using MudBlazor
@inject HttpClient HttpClient
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" GutterBottom="true">上传授权文件</MudText>
        <InputFile OnChange="HandleFileSelected" accept=".license" class="mb-4" />
        @if (isUploading)
        {
            <MudProgressCircular Color="Color.Primary" Size="Size.Medium" Indeterminate="true" class="mb-4" />
        }
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">取消</MudButton>
        <MudButton Color="Color.Primary" OnClick="UploadFile" Disabled="@(selectedFile == null || isUploading)">
            上传
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }
    private IBrowserFile selectedFile;
    private bool isUploading;
    private string errorMessage;
    [Inject]
    private IDialogService DialogService { get; set; }
    [Inject]
    private UserApiServices ApiServices { get; set; }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        errorMessage = null;
    }

    private async Task UploadFile()
    {
        if (selectedFile == null)
        {
            errorMessage = "请选择一个文件";
            return;
        }

        isUploading = true;
        try
        {
            var response = await ApiServices.InitUser(selectedFile);
            if (response == null || response.Code != 200)
            {
                await DialogService.ShowMessageBox(new MessageBoxOptions
                    {
                        Title = "上传失败",
                        Message = response?.Message ?? "授权失败",
                        YesText = "确定",
                        NoText = "取消",
                    });
            }
            else
            {
                await DialogService.ShowMessageBox(new MessageBoxOptions
                    {
                        Title = "上传成功",
                        Message = "授权成功",
                        YesText = "确定",
                        NoText = "取消",
                    });
                MudDialog.Close(DialogResult.Ok(true));
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"上传出错：{ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}